<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karaoguelike</title>
  <style>
    :root {
      --pad: 16px;
      --purple: #7f5bff;
      --pink: #ff4fd8;
      --aqua: #35f2ff;
      --gold: #ffcf56;
    }
    body {
      font-family: "Trebuchet MS", "Segoe UI", system-ui, sans-serif;
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at 10% 10%, rgba(127,91,255,.35), transparent 40%),
        radial-gradient(circle at 90% 20%, rgba(255,79,216,.35), transparent 40%),
        radial-gradient(circle at 30% 80%, rgba(53,242,255,.28), transparent 42%),
        #07070d;
      color:#f4f4f6;
    }
    header {
      padding: 18px var(--pad);
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      background: rgba(7,7,13,.85);
      backdrop-filter: blur(8px);
      z-index: 5;
    }
    h1 { font-size: 18px; margin: 0; font-weight: 750; letter-spacing: .6px; }
    .subtitle { font-size: 12px; color: rgba(255,255,255,.7); }
    .wrap { padding: var(--pad); max-width: 1100px; margin: 0 auto; }
    .card {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(3,3,8,.35);
    }
    .grid { display:grid; grid-template-columns: minmax(260px, 340px) 1fr; gap: 16px; }
    @media (max-width: 900px){
      .grid { grid-template-columns: 1fr; }
      header { align-items: flex-start; }
    }

    .btn {
      background: linear-gradient(120deg, #fff 0%, #f4f4f6 100%);
      color:#101018;
      border:0;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 700;
      cursor:pointer;
      transition: transform .2s ease, box-shadow .2s ease;
      box-shadow: 0 10px 18px rgba(255,255,255,.08);
    }
    .btn.secondary {
      background: rgba(255,255,255,.10);
      color:#fff;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: none;
    }
    .btn.accent {
      background: linear-gradient(120deg, var(--pink), var(--purple));
      color:#fff;
    }
    .btn:disabled { opacity: .55; cursor:not-allowed; transform: none; }
    .btn:hover:not(:disabled) { transform: translateY(-1px) scale(1.01); }

    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }
    .muted { color: rgba(255,255,255,.75); font-size: 12px; line-height: 1.4; }
    .tiny { color: rgba(255,255,255,.55); font-size: 11px; }

    .decklist { display:flex; flex-direction:column; gap: 10px; margin-top: 12px; }
    label.deck {
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      transition: border .2s ease, transform .2s ease;
    }
    label.deck:hover { border-color: rgba(255,255,255,.3); transform: translateY(-1px); }
    label.deck input { transform: scale(1.15); accent-color: var(--pink); }
    .pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.2);
      color: rgba(255,255,255,.9);
      background: rgba(255,255,255,.08);
    }

    .results { display:flex; flex-direction:column; gap: 12px; }
    .resultTitle { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .resultTitle strong { font-size: 14px; }
    .drawn {
      font-size: 22px;
      font-weight: 800;
      margin: 10px 0 0 0;
      letter-spacing: .4px;
      text-shadow: 0 0 18px rgba(53,242,255,.35);
    }
    .kara-card {
      position: relative;
      overflow: hidden;
      border-radius: 18px;
      background:
        linear-gradient(140deg, rgba(255,255,255,.12), rgba(255,255,255,.02)),
        linear-gradient(160deg, rgba(127,91,255,.25), rgba(255,79,216,.2));
      border: 1px solid rgba(255,255,255,.2);
      animation: float 4s ease-in-out infinite;
    }
    .kara-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent 20%, rgba(255,255,255,.18) 45%, transparent 70%);
      transform: translateX(-120%);
      animation: shimmer 4s ease-in-out infinite;
      pointer-events: none;
    }
    .idea-list { margin: 10px 0 0 18px; }
    .idea-list li { margin: 6px 0; }
    .idea-btn { margin-top: 10px; }

    .error { color: #ffb3b3; }
    .ok { color: #b7ffcd; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    @keyframes shimmer { 0%, 100% { transform: translateX(-120%); } 45%, 60% { transform: translateX(120%); } }

    .hero {
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .hero h2 {
      margin: 0;
      font-size: 20px;
      letter-spacing: .3px;
    }
    .hero p { margin: 0; font-size: 13px; color: rgba(255,255,255,.75); }

    .sticky-actions {
      position: sticky;
      bottom: 12px;
      padding-top: 8px;
    }

    @media (max-width: 600px) {
      .row.full-mobile { flex-direction: column; align-items: stretch; }
      .row.full-mobile .btn { width: 100%; justify-content: center; }
      .drawn { font-size: 20px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Karaoguelike</h1>
    <div class="row full-mobile">
      <button class="btn secondary" id="btnReload">Reload data</button>
      <button class="btn accent" id="btnDraw" disabled>Draw a card</button>
      <button class="btn secondary" id="btnChaos" disabled>Add chaos card</button>
      <button class="btn secondary" id="btnReset">End turn</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <div class="card">
        <div class="hero">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <h2>Shuffle the karaoke chaos ✨</h2>
              <p>Pick your decks, draw one card at a time, and stack extra chaos when you want more spice.</p>
            </div>
            <div id="status" class="pill">Not loaded</div>
          </div>
          <p>Reroll any card until the combo sings, then end the turn so the next performer can customize their own draw.</p>
        </div>

        <div style="margin-top:14px;">
          <div class="muted">Decks in play</div>
          <div class="decklist" id="deckList"></div>
        </div>

        <div style="margin-top:14px;" class="row">
          <button class="btn secondary" id="btnSelectAll">Select all</button>
          <button class="btn secondary" id="btnSelectNone">Select none</button>
        </div>

        <div style="margin-top:10px;" class="tiny">
          Tip: turn off “Specific Artist” if you want more open rounds.
        </div>

        <div id="err" class="tiny error" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="resultTitle">
          <strong>Draw</strong>
          <span class="tiny">One card at a time. Add chaos when you want more.</span>
        </div>
        <div class="results" id="results" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * 1) PUT YOUR PUBLISHED CSV LINKS HERE
     * (these are your links; do not swap to /spreadsheets/d/.../export)
     ***********************/
    const CSV_URLS = {
      "MAIN": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJK_-jJKTBYKiYVQz67eXaufFV6z6wxfWY8PFuhPhVp1xOv9dPhJefpJe_RziTvYELRGsHKGRErh6/pub?gid=210868448&single=true&output=csv",
      "Artist Category": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJK_-jJKTBYKiYVQz67eXaufFV6z6wxfWY8PFuhPhVp1xOv9dPhJefpJe_RziTvYELRGsHKGRErh6/pub?gid=2134899012&single=true&output=csv",
      "Specific Artist": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJK_-jJKTBYKiYVQz67eXaufFV6z6wxfWY8PFuhPhVp1xOv9dPhJefpJe_RziTvYELRGsHKGRErh6/pub?gid=933810467&single=true&output=csv",
      "Era": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJK_-jJKTBYKiYVQz67eXaufFV6z6wxfWY8PFuhPhVp1xOv9dPhJefpJe_RziTvYELRGsHKGRErh6/pub?gid=2053657456&single=true&output=csv",
      "Genre": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJK_-jJKTBYKiYVQz67eXaufFV6z6wxfWY8PFuhPhVp1xOv9dPhJefpJe_RziTvYELRGsHKGRErh6/pub?gid=308425524&single=true&output=csv",
      "Prompt": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJK_-jJKTBYKiYVQz67eXaufFV6z6wxfWY8PFuhPhVp1xOv9dPhJefpJe_RziTvYELRGsHKGRErh6/pub?gid=1185779772&single=true&output=csv",
      "Song Title Rule": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCJK_-jJKTBYKiYVQz67eXaufFV6z6wxfWY8PFuhPhVp1xOv9dPhJefpJe_RziTvYELRGsHKGRErh6/pub?gid=186500093&single=true&output=csv"
    };

    /***********************
     * 2) HELPERS
     ***********************/
    async function fetchCsv(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch failed (${res.status}). Check that the tab is published as CSV.`);
      return await res.text();
    }

    // Robust CSV parser: handles quoted commas and quoted newlines.
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        const next = text[i + 1];

        if (ch === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }

        if (ch === ',' && !inQuotes) {
          row.push(cur); cur = "";
          continue;
        }

        if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (ch === '\r' && next === '\n') i++;
          row.push(cur); cur = "";
          // ignore completely empty trailing line
          if (row.some(cell => (cell ?? "").trim() !== "")) rows.push(row.map(x => (x ?? "").trim()));
          row = [];
          continue;
        }

        cur += ch;
      }

      row.push(cur);
      if (row.some(cell => (cell ?? "").trim() !== "")) rows.push(row.map(x => (x ?? "").trim()));
      return rows;
    }

    function uniq(arr) {
      return [...new Set(arr.filter(Boolean))];
    }

    function sample(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function setStatus(text, ok=true) {
      const el = document.getElementById("status");
      el.textContent = text;
      el.className = "pill" + (ok ? " ok" : "");
    }

    function normalizeKey(s) {
      return (s ?? "").trim();
    }

    function splitSuggestionsCell(s) {
      const raw = (s ?? "").trim();
      if (!raw) return [];
      // split on ; | or line breaks if someone pasted multiple suggestions into one cell
      return raw.split(/[;|]\s*|\r?\n/).map(x => x.trim()).filter(Boolean);
    }

    /***********************
     * 3) APP STATE
     ***********************/
    let decks = {};          // { deckName: [cards...] }
    let suggestions = {};    // { deckName: Map(cardName -> [suggestions...]) }
    let selectedDecks = new Set();

    const DEFAULT_DECK_ORDER = ["Artist Category", "Specific Artist", "Era", "Genre", "Prompt", "Song Title Rule"];

    /***********************
     * 4) LOAD DATA
     ***********************/
    async function loadAll() {
      const errEl = document.getElementById("err");
      errEl.textContent = "";
      setStatus("Loading…", true);
      document.getElementById("btnDraw").disabled = true;
      document.getElementById("btnChaos").disabled = true;
      document.getElementById("deckList").innerHTML = "";
      document.getElementById("results").innerHTML = "";

      try {
        if (!CSV_URLS.MAIN) throw new Error("Missing CSV_URLS.MAIN.");

        // --- Load MAIN ---
        const mainText = await fetchCsv(CSV_URLS.MAIN);
        const mainRows = parseCSV(mainText);
        if (mainRows.length < 2) throw new Error("MAIN tab returned no rows. Is it published correctly?");

        const headers = mainRows[0].map(h => (h ?? "").trim());
        const dataRows = mainRows.slice(1);

        decks = {};
        headers.forEach((h, idx) => {
          if (!h) return;
          const colCards = uniq(dataRows.map(r => (r[idx] || "").trim()).filter(Boolean));
          if (colCards.length) decks[h] = colCards;
        });

        if (!Object.keys(decks).length) throw new Error("No decks found in MAIN. Check your header row and data.");

        // default selection: all on
        selectedDecks = new Set(Object.keys(decks));

        // --- Load Suggestions Tabs ---
        suggestions = {};
        for (const deckName of Object.keys(decks)) {
          const url = CSV_URLS[deckName];
          if (!url) continue; // no matching suggestions tab

          let text;
          try {
            text = await fetchCsv(url);
          } catch {
            continue; // don't fail whole app if one tab isn't published
          }

          const rows = parseCSV(text);
          if (rows.length < 2) continue;

          const map = new Map();
          for (const r of rows.slice(1)) {
            const key = normalizeKey(r[0]);
            if (!key) continue;

            const rest = r.slice(1).map(x => (x ?? "").trim()).filter(Boolean);

            // If they used one "Suggestions" cell, split it; else treat each column as a suggestion.
            let sugg = [];
            if (rest.length === 1) sugg = splitSuggestionsCell(rest[0]);
            else sugg = rest.flatMap(cell => splitSuggestionsCell(cell));

            if (sugg.length) map.set(key, sugg);
          }

          if (map.size) suggestions[deckName] = map;
        }

        renderDeckToggles();
        setStatus("Loaded", true);
        document.getElementById("btnDraw").disabled = selectedDecks.size === 0;
        document.getElementById("btnChaos").disabled = selectedDecks.size === 0;
      } catch (e) {
        setStatus("Error", false);
        errEl.textContent = e?.message || String(e);
      }
    }

    /***********************
     * 5) UI
     ***********************/
    function renderDeckToggles() {
      const deckList = document.getElementById("deckList");
      deckList.innerHTML = "";

      const ordered = DEFAULT_DECK_ORDER
        .filter(d => decks[d])
        .concat(Object.keys(decks).filter(d => !DEFAULT_DECK_ORDER.includes(d)));

      for (const deckName of ordered) {
        const count = decks[deckName]?.length ?? 0;

        const label = document.createElement("label");
        label.className = "deck";

        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.style.fontSize = "13px";
        title.textContent = deckName;

        const sub = document.createElement("div");
        sub.className = "tiny";
        sub.textContent = `${count} cards`;

        left.appendChild(title);
        left.appendChild(sub);

        const right = document.createElement("div");
        right.className = "row";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = selectedDecks.has(deckName);
        cb.addEventListener("change", () => {
          if (cb.checked) selectedDecks.add(deckName);
          else selectedDecks.delete(deckName);
          document.getElementById("btnDraw").disabled = selectedDecks.size === 0;
          document.getElementById("btnChaos").disabled = selectedDecks.size === 0;
        });

        right.appendChild(cb);

        label.appendChild(left);
        label.appendChild(right);
        deckList.appendChild(label);
      }
    }

    function draw(clearExisting) {
      const resultsEl = document.getElementById("results");
      if (clearExisting) resultsEl.innerHTML = "";

      const availableDecks = Object.keys(decks).filter(d => selectedDecks.has(d));
      if (!availableDecks.length) return;

      const deckName = sample(availableDecks);
      resultsEl.appendChild(makeDrawnBox(deckName));
    }

    function makeDrawnBox(deckName) {
      const cards = decks[deckName] || [];
      const cardName = sample(cards);

      const box = document.createElement("div");
      box.className = "card kara-card";

      const top = document.createElement("div");
      top.className = "row";
      top.style.justifyContent = "space-between";

      const label = document.createElement("div");
      label.className = "muted";
      label.textContent = deckName;

      const reroll = document.createElement("button");
      reroll.className = "btn secondary";
      reroll.textContent = "Reroll";
      reroll.style.padding = "7px 10px";
      reroll.style.borderRadius = "10px";
      reroll.addEventListener("click", () => {
        box.replaceWith(makeDrawnBox(deckName));
      });

      top.appendChild(label);
      top.appendChild(reroll);
      box.appendChild(top);

      const drawn = document.createElement("div");
      drawn.className = "drawn";
      drawn.textContent = cardName;
      box.appendChild(drawn);

      const suggList = suggestions[deckName]?.get(cardName) || [];
      if (suggList.length) {
        const ideaBtn = document.createElement("button");
        ideaBtn.className = "btn secondary idea-btn";
        ideaBtn.textContent = "Need ideas? Click here!";

        const ul = document.createElement("ul");
        ul.className = "idea-list";
        ul.hidden = true;

        for (const s of suggList) {
          const li = document.createElement("li");
          li.textContent = s;
          ul.appendChild(li);
        }

        ideaBtn.addEventListener("click", () => {
          ul.hidden = !ul.hidden;
          ideaBtn.textContent = ul.hidden ? "Need ideas? Click here!" : "Hide ideas";
        });

        box.appendChild(ideaBtn);
        box.appendChild(ul);
      }

      return box;
    }

    /***********************
     * 6) EVENTS
     ***********************/
    document.getElementById("btnReload").addEventListener("click", loadAll);
    document.getElementById("btnDraw").addEventListener("click", () => draw(true));
    document.getElementById("btnChaos").addEventListener("click", () => draw(false));
    document.getElementById("btnReset").addEventListener("click", () => {
      document.getElementById("results").innerHTML = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.getElementById("btnSelectAll").addEventListener("click", () => {
      selectedDecks = new Set(Object.keys(decks));
      renderDeckToggles();
      document.getElementById("btnDraw").disabled = selectedDecks.size === 0;
      document.getElementById("btnChaos").disabled = selectedDecks.size === 0;
    });

    document.getElementById("btnSelectNone").addEventListener("click", () => {
      selectedDecks = new Set();
      renderDeckToggles();
      document.getElementById("btnDraw").disabled = true;
      document.getElementById("btnChaos").disabled = true;
    });

    // Initial load
    loadAll();
  </script>
</body>
</html>
